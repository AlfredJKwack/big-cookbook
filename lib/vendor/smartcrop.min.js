!function(){"use strict";function a(c){this.options=b({},a.DEFAULTS,c)}function b(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];if(d)for(var e in d)a[e]=d[e]}return a}function c(a){return a=16*((a-1/3+1)%2*.5-.5),Math.max(1-a*a,0)}function d(a,b,c){return.5126*c+.7152*b+.0722*a}function e(a,b){return d(a[b],a[b+1],a[b+2])}function f(a,b,c){var d=h(a/255,b/255,c/255),e=g(a/255,b/255,c/255);if(d===e)return 0;var f=(d+e)/2,i=d-e;return f>.5?i/(2-d-e):i/(d+e)}a.DEFAULTS={width:0,height:0,aspect:0,cropWidth:0,cropHeight:0,detailWeight:.2,skinColor:[.78,.57,.44],skinBias:.01,skinBrightnessMin:.2,skinBrightnessMax:1,skinThreshold:.8,skinWeight:1.8,saturationBrightnessMin:.05,saturationBrightnessMax:.9,saturationThreshold:.4,saturationBias:.2,saturationWeight:.3,scoreDownSample:8,step:8,scaleStep:.1,minScale:.9,maxScale:1,edgeRadius:.4,edgeWeight:-20,outsideImportance:-.5,ruleOfThirds:!0,prescale:!0,canvasFactory:null,debug:!1},a.crop=function(b,c,d){if(c.aspect&&(c.width=c.aspect,c.height=1),b.naturalWidth&&(b.naturalWidth!=b.width||b.naturalHeight!=b.height)){var e=new a(c).canvas(b.naturalWidth,b.naturalHeight),f=e.getContext("2d");e.width=b.naturalWidth,e.height=b.naturalHeight,f.drawImage(b,0,0),b=e}var i=1,j=1;c.width&&c.height&&(i=g(b.width/c.width,b.height/c.height),c.cropWidth=~~(c.width*i),c.cropHeight=~~(c.height*i),c.minScale=g(c.maxScale||a.DEFAULTS.maxScale,h(1/i,c.minScale||a.DEFAULTS.minScale)));var k=new a(c);if(c.width&&c.height&&c.prescale!==!1)if(j=1/i/c.minScale,j<1){var l=k.canvas(b.width*j,b.height*j),m=l.getContext("2d");m.drawImage(b,0,0,b.width,b.height,0,0,l.width,l.height),b=l,k.options.cropWidth=~~(c.cropWidth*j),k.options.cropHeight=~~(c.cropHeight*j)}else j=1;for(var n=k.analyse(b),o=0,p=n.crops.length;o<p;o++){var q=n.crops[o];q.x=~~(q.x/j),q.y=~~(q.y/j),q.width=~~(q.width/j),q.height=~~(q.height/j)}return d(n),n},a.isAvailable=function(a){try{var b=new this(a),c=b.canvas(16,16);return"function"==typeof c.getContext}catch(d){return!1}},a.prototype={canvas:function(a,b){if(null!==this.options.canvasFactory)return this.options.canvasFactory(a,b);var c=document.createElement("canvas");return c.width=a,c.height=b,c},edgeDetect:function(a,b){for(var c=a.data,d=b.data,f=a.width,g=a.height,h=0;h<g;h++)for(var i=0;i<f;i++){var j,k=4*(h*f+i);j=0===i||i>=f-1||0===h||h>=g-1?e(c,k):4*e(c,k)-e(c,k-4*f)-e(c,k-4)-e(c,k+4)-e(c,k+4*f),d[k+1]=j}},skinDetect:function(a,b){for(var c=a.data,e=b.data,f=a.width,g=a.height,h=this.options,i=0;i<g;i++)for(var j=0;j<f;j++){var k=4*(i*f+j),l=d(c[k],c[k+1],c[k+2])/255,m=this.skinColor(c[k],c[k+1],c[k+2]);m>h.skinThreshold&&l>=h.skinBrightnessMin&&l<=h.skinBrightnessMax?e[k]=(m-h.skinThreshold)*(255/(1-h.skinThreshold)):e[k]=0}},saturationDetect:function(a,b){for(var c=a.data,e=b.data,g=a.width,h=a.height,i=this.options,j=0;j<h;j++)for(var k=0;k<g;k++){var l=4*(j*g+k),m=d(c[l],c[l+1],c[l+2])/255,n=f(c[l],c[l+1],c[l+2]);n>i.saturationThreshold&&m>=i.saturationBrightnessMin&&m<=i.saturationBrightnessMax?e[l+2]=(n-i.saturationThreshold)*(255/(1-i.saturationThreshold)):e[l+2]=0}},crops:function(a){for(var b=[],c=a.width,d=a.height,e=this.options,f=g(c,d),h=e.cropWidth||f,i=e.cropHeight||f,j=e.maxScale;j>=e.minScale;j-=e.scaleStep)for(var k=0;k+i*j<=d;k+=e.step)for(var l=0;l+h*j<=c;l+=e.step)b.push({x:l,y:k,width:h*j,height:i*j});return b},score:function(a,b){for(var c={detail:0,saturation:0,skin:0,total:0},d=this.options,e=a.data,f=d.scoreDownSample,g=1/f,h=a.height*f,i=a.width*f,j=a.width,k=0;k<h;k+=f)for(var l=0;l<i;l+=f){var m=4*(~~(k*g)*j+~~(l*g)),n=this.importance(b,l,k),o=e[m+1]/255;c.skin+=e[m]/255*(o+d.skinBias)*n,c.detail+=o*n,c.saturation+=e[m+2]/255*(o+d.saturationBias)*n}return c.total=(c.detail*d.detailWeight+c.skin*d.skinWeight+c.saturation*d.saturationWeight)/b.width/b.height,c},importance:function(a,b,d){var e=this.options;if(a.x>b||b>=a.x+a.width||a.y>d||d>=a.y+a.height)return e.outsideImportance;b=(b-a.x)/a.width,d=(d-a.y)/a.height;var f=2*i(.5-b),g=2*i(.5-d),h=Math.max(f-1+e.edgeRadius,0),j=Math.max(g-1+e.edgeRadius,0),l=(h*h+j*j)*e.edgeWeight,m=1.41-k(f*f+g*g);return e.ruleOfThirds&&(m+=1.2*Math.max(0,m+l+.5)*(c(f)+c(g))),m+l},skinColor:function(a,b,c){var d=k(a*a+b*b+c*c),e=this.options,f=a/d-e.skinColor[0],g=b/d-e.skinColor[1],h=c/d-e.skinColor[2],i=k(f*f+g*g+h*h);return 1-i},analyse:function(a){var b={},c=this.options,d=this.canvas(a.width,a.height),e=d.getContext("2d");e.drawImage(a,0,0);var f=e.getImageData(0,0,d.width,d.height),g=e.getImageData(0,0,d.width,d.height);this.edgeDetect(f,g),this.skinDetect(f,g),this.saturationDetect(f,g);var h=this.canvas(j(a.width/c.scoreDownSample),j(a.height/c.scoreDownSample)),i=h.getContext("2d");e.putImageData(g,0,0),i.drawImage(d,0,0,d.width,d.height,0,0,h.width,h.height);for(var k=i.getImageData(0,0,h.width,h.height),l=-(1/0),m=null,n=this.crops(a),o=0,p=n.length;o<p;o++){var q=n[o];q.score=this.score(k,q),q.score.total>l&&(m=q,l=q.score.total)}if(b.crops=n,b.topCrop=m,c.debug&&m){e.fillStyle="rgba(255, 0, 0, 0.1)",e.fillRect(m.x,m.y,m.width,m.height);for(var r=0;r<g.height;r++)for(var s=0;s<g.width;s++){var t=4*(r*g.width+s),u=this.importance(m,s,r);u>0&&(g.data[t+1]+=32*u),u<0&&(g.data[t]+=u*-64),g.data[t+3]=255}e.putImageData(g,0,0),e.strokeStyle="rgba(255, 0, 0, 0.8)",e.strokeRect(m.x,m.y,m.width,m.height),b.debugCanvas=d}return b}};var g=Math.min,h=Math.max,i=Math.abs,j=Math.ceil,k=Math.sqrt;"undefined"!=typeof define&&define.amd&&define(function(){return a}),"undefined"!=typeof exports?exports.SmartCrop=a:"undefined"!=typeof navigator&&(window.SmartCrop=a),"undefined"!=typeof module&&(module.exports=a)}();